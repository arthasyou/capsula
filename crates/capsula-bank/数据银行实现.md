# Capsula Bank 实现综述

## 1. 项目定位与整体流程

Capsula Bank 是基于 Axum 的数据银行服务端，实现“数据胶囊”托管、授权与访问的核心能力。启动流程如下：

1. 读取 `config/services.toml`，初始化日志、HTTP、上传/存储与 SurrealDB 配置。
2. 使用 `keys/system_private.pem` 加载系统 RSA 私钥，作为统一加密/解密根。
3. 连接 SurrealDB，创建胶囊、令牌、权限、私钥等表。
4. 结合 `routes::v1` 与 `routes::v2` 暴露 REST API，并挂载 Swagger UI 文档。

## 2. 代码结构

| 模块                | 说明                                                                     |
| ------------------- | ------------------------------------------------------------------------ |
| `main.rs`           | 程序入口，负责配置载入、系统密钥初始化、数据库建表、HTTP 服务启动。      |
| `settings.rs`       | 配置模型，包含 HTTP、SurrealDB、密钥、存储、上传等子配置。               |
| `routes/`           | V1/V2 API 路由与 OpenAPI 注解。                                          |
| `handlers/`         | 业务处理器：V1 管理胶囊与令牌，V2 提供上传封装、外部化创建与预签名 URL。 |
| `db/`               | SurrealDB 表结构定义与 CRUD 封装：胶囊、令牌、原子/分子权限、私钥等。    |
| `models/`           | 胶囊、权限、令牌、请求 DTO，映射 PPT 中的业务概念。                      |
| `services/`         | 文本提取、BNF 解析、元数据生成、存储适配、本地临时文件等服务。           |
| `utils/`            | 胶囊解密、Cap1 封装、策略投影，支持 Level0/Level1 多视图输出。           |
| `static_files::key` | 系统 RSA 密钥的全局 OnceLock 存取。                                      |

## 3. 功能实现亮点

### 3.1 胶囊管理（V1）

- `POST /v1/capsule/`：接收完整胶囊 JSON，解析 header 并持久化 `CapsuleRecord`。
- `GET /v1/capsule/{id}`：按 ID 查询。
- `GET /v1/capsule/owner/{owner_id}`：按所有者查询。
- `GET /v1/capsule/search`：按所有者/类型/阶段过滤。

`CapsuleRecord` 保存完整 JSON（含 header/policy/payload），并额外保留 `stage`、`content_type`、`owner_id`、`created_at` 便于索引，契合 PPT“状态 A/B/C”与多角色流转描述。

### 3.2 权限授权（V1）

- `POST /v1/auth/grant`：生成随机 token，写入 tokens 表；以 scopes 表示原子/分子权限集合。
- `POST /v1/auth/use`：校验 token 哈希、过期、状态；更新使用次数。
- `POST /v1/auth/revoke`：撤销令牌；`/list` 可查询胶囊或主体的令牌。

`models::permission` 将 PPT《数据胶囊权属向量码》中的 14 个原子权限及 10 个分子组合固化为默认数据，配合 `bin/init_permissions.rs` 初始化程序。

### 3.3 V2 胶囊封装流水线

- `/v2/capsule/upload`：接收 multipart 文件，写入临时目录，调用 `CapsuleSealer`：
  1. `SimpleTextExtractor` 提取文本（当前只支持 text/\*）。
  2. `SimpleBnfParser` 将文本解析为规则结构。
  3. `MetadataGenerator` 生成文件元信息（大小、哈希等）。
  4. `LocalStorage` 存储原文件并返回 URL。
  5. 准备 Cap0/Cap1 封装（Cap0 仍未实现，返回 `Unsupported`）。
- `/v2/capsule/create`：走“外部化方案”，由客户端提供 Cap0 URL、元数据、结构化数据，本地利用 `capsula_util::create_cap1_capsule` 创建 Cap1，并 TODO 持久化。
- `/v2/storage/presigned-url`：校验参数后返回占位的预签名 URL，真实 S3 实现待接入。

### 3.4 数据视图与策略

- `utils::capsula_util::fetch_and_decrypt_capsules` 使用系统密钥解密用户胶囊，供后续视图处理。
- `utils::cap1_util` 提供：
  - Level0 视图：输出 Cap1 原始元数据/BNF。
  - Level1 视图：构造统计数据集，调用外部 LLM（`model_gateway_rs`）生成结构化总结，呼应 PPT 中的“多级披露/医生概览”需求。
- `policy_util` 按级别分发视图处理策略。

## 4. 与刘飓峰 PPT 文档对应关系

| PPT 内容                           | 代码实现映射                                                            |
| ---------------------------------- | ----------------------------------------------------------------------- |
| 数据生命周期：状态 A/B/C、场景 1/2 | `CapsuleRecord.stage`、owner/bank/使用者分工、授权 API。                |
| 多级隐私披露（0–4 级，可见/可用）  | Level0/Level1 视图、token scopes、未来可扩展 Stage 控制。               |
| 权属向量码矩阵                     | `models::permission` 默认原子/分子权限，`init_permissions` 初始化程序。 |
| 数据银行与 MVP 架构                | `routes::v1`（内部管理）与 `routes::v2`（对外集成）分层设计。           |
| 文件外部化 & S3 上传               | `/v2/capsule/create` + `/v2/storage/presigned-url` 预留接口。           |
| PKI 极简/标准流程                  | `static_files::key` 仅实现托管密钥，PKI/证书 API 有待补充。             |
