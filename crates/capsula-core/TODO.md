# 数据胶囊封包与解包功能实现 TODO

## 项目概述
实现基于"数据胶囊封包与解包.md"规范的1阶数据胶囊功能，包括封包(Encapsulation)和解包(Decapsulation)核心操作。

## 架构设计

### 依赖关系
- `capsula-crypto`: 提供加密算法（AES、SHA-256、数字签名）
- `capsula-key`: 提供密钥管理和私钥功能
- `capsula-pki`: 提供PKI相关功能

## 核心功能 TODO

### 🚀 Phase 1: 基础设施和依赖更新

- [ ] **1.1 更新 Cargo.toml 依赖**
  - [ ] 添加 `capsula-crypto` 依赖
  - [ ] 添加 `capsula-key` 依赖
  - [ ] 添加必要的加密和序列化依赖

- [ ] **1.2 错误处理系统**
  - [ ] 扩展 `error.rs` 支持封包/解包相关错误
  - [ ] 添加加密/解密错误类型
  - [ ] 添加签名验证错误类型

### 📦 Phase 2: 封包 (Encapsulation) 功能

- [ ] **2.1 数据格式化与预处理**
  - [ ] 实现原始报告的结构化解析
  - [ ] 添加数据格式验证功能
  - [ ] 实现EBNF规范的数据结构转换

- [ ] **2.2 摘要计算**
  - [ ] 实现SHA-256摘要计算
  - [ ] 创建Digest结构的构建功能
  - [ ] 添加数据完整性验证基准

- [ ] **2.3 对称加密实现**
  - [ ] 随机生成AES密钥 (CEK - Content Encryption Key)
  - [ ] 使用AES-256-GCM加密原始数据
  - [ ] 实现AAD (Additional Authenticated Data) 生成

- [ ] **2.4 密钥分发机制**
  - [ ] 实现KeyWrap结构的创建
  - [ ] 用Owner公钥加密CEK
  - [ ] 用User公钥加密CEK (多接收方支持)
  - [ ] 创建Keyring管理

- [ ] **2.5 数字签名**
  - [ ] 使用Producer私钥对胶囊签名
  - [ ] 实现签名数据的标准化表示
  - [ ] 添加签名验证预备功能

- [ ] **2.6 策略绑定**
  - [ ] 实现访问控制策略附加
  - [ ] 支持角色和时间限制
  - [ ] 策略序列化和存储

- [ ] **2.7 审计记录**
  - [ ] 生成"创建胶囊"审计事件
  - [ ] 时间戳和操作者记录
  - [ ] 审计信息持久化

### 📤 Phase 3: 解包 (Decapsulation) 功能

- [ ] **3.1 结构校验**
  - [ ] 胶囊格式完整性检查
  - [ ] EBNF规范符合性验证
  - [ ] 版本兼容性检查

- [ ] **3.2 数字签名验证**
  - [ ] 使用Producer公钥验证签名
  - [ ] 防篡改检查
  - [ ] 签名完整性确认

- [ ] **3.3 策略检查**
  - [ ] 访问权限验证
  - [ ] 角色匹配检查
  - [ ] 时间限制验证
  - [ ] Rego策略评估 (可选)

- [ ] **3.4 密钥解密**
  - [ ] 从Keyring找到对应的加密CEK
  - [ ] 使用接收者私钥解密CEK
  - [ ] CEK有效性验证

- [ ] **3.5 数据解密**
  - [ ] 使用CEK解密载荷数据
  - [ ] AAD验证
  - [ ] 明文数据还原

- [ ] **3.6 完整性验证**
  - [ ] 重新计算数据摘要
  - [ ] 与存储的fingerprint对比
  - [ ] 数据一致性确认

- [ ] **3.7 审计记录**
  - [ ] 生成"读取/解包"审计事件
  - [ ] 操作追踪记录

### 🔧 Phase 4: 核心API设计

- [ ] **4.1 封包API**
  - [ ] `CapsulaBuilder` 构建器模式
  - [ ] `encapsulate()` 主要封包函数
  - [ ] 支持多种数据输入格式

- [ ] **4.2 解包API**
  - [ ] `CapsuleDecryptor` 解包器
  - [ ] `decapsulate()` 主要解包函数
  - [ ] 权限验证接口

- [ ] **4.3 密钥管理集成**
  - [ ] 与capsula-key集成
  - [ ] 私钥导入/导出
  - [ ] 密钥轮换支持

### 🧪 Phase 5: 测试和验证

- [ ] **5.1 单元测试**
  - [ ] 封包流程测试
  - [ ] 解包流程测试
  - [ ] 错误场景测试
  - [ ] 边界条件测试

- [ ] **5.2 集成测试**
  - [ ] 端到端封包解包测试
  - [ ] 多用户场景测试
  - [ ] 权限控制测试

- [ ] **5.3 安全测试**
  - [ ] 密钥泄漏防护测试
  - [ ] 篡改检测测试
  - [ ] 重放攻击防护测试

### 📝 Phase 6: 文档和示例

- [ ] **6.1 API文档**
  - [ ] Rust doc注释完善
  - [ ] 使用示例
  - [ ] 最佳实践指南

- [ ] **6.2 示例代码**
  - [ ] 基础封包/解包示例
  - [ ] 多用户权限示例
  - [ ] 医疗数据处理示例

## 技术规范

### 加密标准
- **对称加密**: AES-256-GCM
- **非对称加密**: RSA-2048/P-256/Ed25519 (根据密钥类型)
- **哈希算法**: SHA-256
- **密钥派生**: HKDF

### 数据格式
- **序列化**: JSON (serde)
- **编码**: Base64 (密文和签名)
- **时间戳**: RFC3339格式
- **标识符**: CID格式

### 安全考虑
- [ ] 防止密钥扩散 (集中解密模式考虑)
- [ ] 短期授权和水印
- [ ] 最小化分组权限
- [ ] 完整审计追踪

## 里程碑

1. **M1**: 基础依赖和错误系统 (Phase 1)
2. **M2**: 核心封包功能 (Phase 2)
3. **M3**: 核心解包功能 (Phase 3)  
4. **M4**: API设计完成 (Phase 4)
5. **M5**: 测试验证完成 (Phase 5)
6. **M6**: 文档和发布 (Phase 6)

## 优先级说明

🔴 **High**: Phase 1-4 (核心功能实现)
🟡 **Medium**: Phase 5 (测试验证)  
🟢 **Low**: Phase 6 (文档优化)

---
*创建时间: 2024年*  
*状态: 待开始*