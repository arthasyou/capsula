# 数据胶囊权限机制设计方案

## 设计目标

为数据胶囊授权系统设计一套高效、灵活、可扩展的权限表示和验证机制，满足医疗等敏感领域的复杂权限控制需求。

## 权限表示方法对比分析

### 位掩码（二进制）方案

#### 基本原理
使用二进制位来表示不同的权限，每个位代表一种权限状态。

#### 权限定义示例
```
基础权限位定义：
READ = 0001 (1)      - 读取权限
WRITE = 0010 (2)     - 写入权限  
EXECUTE = 0100 (4)   - 执行权限
ADMIN = 1000 (8)     - 管理权限

用户权限示例：
护士 = 0001 (1)      - 仅读取
医生 = 0111 (7)      - 读写执行
主管 = 1111 (15)     - 全部权限
```

#### 优势
- **极致性能**：位运算操作复杂度为O(1)
- **存储高效**：32位整数可表示32种权限
- **操作简单**：使用与、或、异或等位运算
- **成熟稳定**：Unix文件系统等广泛应用

#### 劣势
- **扩展性限制**：权限种类受整数位数限制
- **可读性差**：二进制数字不够直观
- **细粒度不足**：难以表达复杂权限关系

### 权限数组方案

#### 基本原理
使用字符串数组来表示权限集合，每个字符串代表一个具体权限。

#### 权限定义示例
```
用户权限数组：
["read_summary", "read_metadata", "write_notes", "view_images"]

角色权限数组：
["admin", "senior_doctor", "nurse", "technician"]

操作权限数组：
["create_record", "update_diagnosis", "delete_temp_data"]
```

#### 优势
- **可读性强**：权限名称直观易懂
- **扩展性好**：可随时增加新权限类型
- **灵活性高**：支持任意粒度的权限定义
- **易于调试**：权限内容一目了然

#### 劣势
- **性能开销**：字符串比较和查找较慢
- **存储占用**：比位掩码占用更多存储空间
- **一致性风险**：权限名称可能不统一

### 权限矩阵方案

#### 基本原理
使用二维矩阵表示角色与权限的对应关系。

#### 矩阵结构示例
```
权限矩阵：
          读取摘要  读取详情  写入数据  管理权限
护士组      ✓       ✗       ✗       ✗
医生组      ✓       ✓       ✓       ✗  
管理组      ✓       ✓       ✓       ✓
技师组      ✓       ✓       ✗       ✗
```

#### 优势
- **直观明确**：权限关系清晰可见
- **便于管理**：适合图形界面展示和编辑
- **标准化好**：符合RBAC（基于角色的访问控制）标准

#### 劣势
- **存储冗余**：稀疏矩阵造成空间浪费
- **维护复杂**：权限变更需要更新整个矩阵
- **扩展困难**：新增权限需要重构矩阵结构

## 推荐方案：分层混合权限设计

### 设计理念

针对医疗场景的复杂权限需求，采用**三层混合权限架构**，结合不同方案的优势：

1. **基础权限层**：使用位掩码处理高频基础权限
2. **细粒度权限层**：使用数组处理特殊权限需求
3. **角色映射层**：使用矩阵管理角色权限关系

### 三层架构设计

#### 第一层：基础权限（位掩码）

**数据访问层级权限**
```
SUMMARY_ACCESS = 1    (0001) - 摘要层访问
METADATA_ACCESS = 2   (0010) - 元数据层访问  
FULL_ACCESS = 4       (0100) - 完整数据访问
```

**操作类型权限**
```
READ_OPERATION = 8    (0001000) - 读取操作
WRITE_OPERATION = 16  (0010000) - 写入操作
DELETE_OPERATION = 32 (0100000) - 删除操作
```

**管理级别权限**
```
GRANT_PERMISSION = 64  (01000000) - 权限分发
REVOKE_PERMISSION = 128 (10000000) - 权限撤销
```

#### 第二层：细粒度权限（数组）

**字段级权限控制**
```
字段访问权限：
["patient_name", "patient_id", "diagnosis", "treatment_plan", "lab_results"]

敏感信息权限：
["social_security", "insurance_info", "emergency_contact"]
```

**时间窗口权限**
```
时间限制权限：
["business_hours_only", "emergency_access", "weekend_restricted"]
```

**条件访问权限**
```
条件性权限：
["same_department_only", "attending_doctor_only", "supervisor_approval_required"]
```

#### 第三层：角色映射（矩阵）

**医疗角色权限矩阵**
```
角色权限映射表：

角色类型    基础权限值  细粒度权限                    特殊条件
护士        9 (1+8)     ["patient_name", "vital_signs"] ["same_department_only"]
医生        31 (1+2+4+8+16) ["diagnosis", "treatment"]   ["attending_cases"]
主管医生    255 (全部)   ["all_fields"]               ["department_wide"]
技师        11 (1+2+8)   ["lab_results", "images"]    ["technical_data_only"]
管理员      255 (全部)   ["all_fields", "admin"]      ["system_wide"]
```

### 权限检查流程

#### 验证步骤
```
步骤1: 基础权限快速检查
使用位运算验证用户基础权限是否满足要求

步骤2: 细粒度权限验证  
检查用户是否拥有访问特定字段的权限

步骤3: 条件权限评估
验证当前访问是否满足约束条件

步骤4: 时间窗口检查
确认访问时间是否在允许范围内

步骤5: 上下文验证
验证访问环境是否符合权限要求
```

### 权限数据结构

#### 权限包结构
```
权限包组成：
{
    基础权限: 32位整数 (位掩码)
    扩展权限: 字符串数组 (细粒度权限)
    约束条件: 键值对映射 (条件权限)
    有效期限: 时间范围 (时间约束)
    上下文要求: 环境条件 (访问约束)
}
```

#### 角色定义结构
```
角色定义：
{
    角色名称: 字符串标识
    基础权限模板: 位掩码值
    默认扩展权限: 权限数组
    角色层级: 继承关系
    适用范围: 应用域限制
}
```

## 医疗场景权限应用

### 典型权限场景

#### 护士权限配置
```
基础权限: SUMMARY_ACCESS + READ_OPERATION = 9
扩展权限: ["patient_vitals", "nursing_notes", "medication_schedule"]
约束条件: ["same_ward_only", "shift_hours_only"]
```

#### 医生权限配置
```
基础权限: FULL_ACCESS + READ_OPERATION + WRITE_OPERATION = 28
扩展权限: ["diagnosis", "treatment_plan", "prescription", "lab_orders"]
约束条件: ["attending_patients", "department_access"]
```

#### 主管医生权限配置
```
基础权限: 全部基础权限 = 255
扩展权限: ["all_patient_data", "staff_management", "resource_allocation"]
约束条件: ["department_wide", "emergency_override"]
```

### 权限继承机制

#### 层级继承规则
```
继承链条：
主管医生 → 医生 → 实习医生
护士长 → 护士 → 护理学生
```

#### 权限叠加原则
- **基础权限**：高级角色包含低级角色的所有基础权限
- **扩展权限**：可选择性继承，支持权限定制
- **约束条件**：可被上级权限覆盖或放宽

## 性能优化策略

### 缓存机制
- **权限缓存**：缓存用户权限计算结果
- **角色缓存**：缓存角色权限模板
- **验证缓存**：缓存权限验证结果

### 索引优化
- **位掩码索引**：基础权限快速匹配
- **权限哈希**：扩展权限快速查找
- **时间索引**：有效期权限快速筛选

### 批量操作
- **权限批量验证**：一次性验证多个权限
- **角色批量分配**：批量分配用户角色
- **权限批量更新**：批量更新权限配置

## 扩展性设计

### 权限动态扩展
- **插件化权限**：支持自定义权限类型
- **动态权限注册**：运行时注册新权限
- **权限版本管理**：权限定义版本控制

### 跨域权限支持
- **多租户权限**：支持多机构权限隔离
- **联邦权限**：支持跨机构权限协作
- **权限委托**：支持临时权限委托机制

## 安全性考虑

### 权限最小化原则
- **默认拒绝**：未明确授权的操作一律拒绝
- **最小权限**：只授予完成任务所需的最小权限
- **定期审查**：定期审查和清理过期权限

### 权限审计
- **权限变更记录**：记录所有权限变更操作
- **异常访问检测**：检测异常的权限使用模式
- **权限使用统计**：统计权限使用频率和效果

### 防护措施
- **权限加密存储**：敏感权限信息加密保存
- **传输加密**：权限数据传输过程加密
- **完整性校验**：权限数据完整性验证机制